<!DOCTYPE html>

<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>Cargo Crisis</title>
<link href="https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@400;600;700;800&family=Sarabun:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<style>
:root{
  --bg:#050d1a;--panel:#0a1828;--border:rgba(255,255,255,.08);
  --gold:#f5c842;--gold2:#c9910a;--red:#e63946;--green:#2dc653;
  --yellow:#ffd166;--blue:#4895ef;--text:#e8f4fd;--muted:#5a8ab0;
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
html,body{height:100%;overflow:hidden;}
body{font-family:'Sarabun',sans-serif;background:var(--bg);color:var(--text);}

/* screens */
.screen{display:none;position:fixed;inset:0;overflow-y:auto;}
.screen.show{display:block;}
#splash{display:none;position:fixed;inset:0;flex-direction:column;align-items:center;justify-content:center;
background:radial-gradient(ellipse at 50% 40%,#0d2244,#050d1a 70%);}
#splash.show{display:flex;}

/* splash */
.splash-ship{font-size:clamp(3rem,10vw,6rem);animation:float 3s ease-in-out infinite;}
@keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-14px)}}
.splash-title{font-family:‚ÄòChakra Petch‚Äô,sans-serif;font-size:clamp(2rem,8vw,4rem);
font-weight:800;color:var(‚Äìgold);letter-spacing:4px;text-align:center;margin:12px 0 6px;}
.splash-sub{color:var(‚Äìmuted);font-size:.95rem;text-align:center;margin-bottom:32px;}
.mode-btns{display:flex;gap:14px;flex-wrap:wrap;justify-content:center;}

/* buttons */
.btn{padding:14px 24px;border:none;border-radius:12px;font-family:‚ÄòChakra Petch‚Äô,sans-serif;
font-size:.95rem;font-weight:700;cursor:pointer;transition:all .15s;letter-spacing:1px;}
.btn:active{transform:scale(.96);}
.btn-gold{background:linear-gradient(135deg,var(‚Äìgold),var(‚Äìgold2));color:#0a0a00;}
.btn-ghost{background:rgba(255,255,255,.06);color:var(‚Äìtext);border:1px solid rgba(255,255,255,.12);}
.btn-green{background:linear-gradient(135deg,var(‚Äìgreen),#18803a);color:#fff;}
.btn-red{background:linear-gradient(135deg,var(‚Äìred),#a01020);color:#fff;}
.btn-full{width:100%;display:block;margin-bottom:10px;}
.btn:disabled{opacity:.4;cursor:not-allowed;}

/* cards */
.card{background:rgba(255,255,255,.05);border:1px solid var(‚Äìborder);border-radius:14px;padding:16px;margin-bottom:14px;}
.card-label{font-size:.68rem;letter-spacing:2.5px;color:var(‚Äìmuted);text-transform:uppercase;margin-bottom:10px;}
input[type=text],input[type=number]{width:100%;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.1);
border-radius:10px;padding:12px 14px;color:var(‚Äìtext);font-family:‚ÄòSarabun‚Äô,sans-serif;font-size:1rem;outline:none;margin-bottom:10px;}
input:focus{border-color:var(‚Äìgold);}

/* host */
#host{padding:20px 16px 60px;}
.page-title{font-family:‚ÄòChakra Petch‚Äô,sans-serif;font-size:1.2rem;color:var(‚Äìgold);letter-spacing:2px;text-align:center;margin-bottom:20px;}
.player-chip{display:flex;align-items:center;justify-content:space-between;
background:rgba(255,255,255,.04);border-radius:10px;padding:10px 14px;margin-bottom:8px;}
.chip-del{background:none;border:none;color:var(‚Äìmuted);cursor:pointer;font-size:1rem;padding:4px 8px;}
.setting-row{display:flex;gap:10px;}
.setting-row>div{flex:1;}
.setting-row label{font-size:.75rem;color:var(‚Äìmuted);display:block;margin-bottom:4px;}
.choice-row{display:flex;justify-content:space-between;align-items:center;
background:rgba(255,255,255,.04);border-radius:8px;padding:9px 12px;margin-bottom:6px;font-size:.85rem;}

/* join */
#join{background:radial-gradient(ellipse at 50% 30%,#0d2244,#050d1a 70%);}
.join-inner{min-height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:24px;}
.join-title{font-family:‚ÄòChakra Petch‚Äô,sans-serif;font-size:clamp(1.5rem,6vw,2.5rem);
font-weight:800;color:var(‚Äìgold);text-align:center;margin-bottom:8px;}
.join-sub{color:var(‚Äìmuted);text-align:center;margin-bottom:24px;font-size:.9rem;}
.join-form{width:100%;max-width:340px;}
.w-chip{background:rgba(255,255,255,.05);border-radius:10px;padding:9px 14px;margin-bottom:8px;
font-size:.9rem;animation:slideIn .3s ease;}
@keyframes slideIn{from{transform:translateX(-16px);opacity:0}to{transform:none;opacity:1}}

/* player */
#player{background:var(‚Äìbg);}
.player-inner{min-height:100vh;display:flex;flex-direction:column;align-items:center;
padding:20px 16px 60px;max-width:460px;margin:0 auto;}
.page-header{font-family:‚ÄòChakra Petch‚Äô,sans-serif;font-size:1.1rem;color:var(‚Äìgold);
letter-spacing:2px;text-align:center;margin-bottom:18px;}

/* display */
#display{background:var(‚Äìbg);}
.disp-header{display:flex;align-items:center;padding:12px 24px;
border-bottom:1px solid var(‚Äìborder);background:var(‚Äìpanel);position:sticky;top:0;z-index:10;}
.disp-logo{font-family:‚ÄòChakra Petch‚Äô,sans-serif;font-weight:800;font-size:1.2rem;color:var(‚Äìgold);letter-spacing:3px;flex-shrink:0;}
.scoreboard{display:flex;gap:8px;overflow-x:auto;padding:2px 0;flex:1;margin-left:16px;justify-content:flex-end;}
.sc{background:rgba(255,255,255,.06);border:1px solid var(‚Äìborder);border-radius:10px;
padding:6px 12px;text-align:center;min-width:72px;flex-shrink:0;transition:border-color .3s;}
.sc.active{border-color:var(‚Äìgold);}
.sc-name{font-size:.65rem;color:var(‚Äìmuted);}
.sc-val{font-family:‚ÄòChakra Petch‚Äô,sans-serif;font-size:.95rem;font-weight:700;color:var(‚Äìgold);}
.disp-main{display:flex;align-items:center;justify-content:center;padding:24px;min-height:calc(100vh - 56px);}

/* idle */
.idle-wrap{text-align:center;}
.idle-ship{font-size:clamp(4rem,14vw,9rem);animation:float 3s ease-in-out infinite;}
.idle-t{font-family:‚ÄòChakra Petch‚Äô,sans-serif;font-size:clamp(1rem,3vw,2rem);color:var(‚Äìmuted);margin-top:16px;}
.idle-sub{font-size:clamp(.7rem,1.5vw,.9rem);color:rgba(255,255,255,.25);margin-top:8px;}
.w-badges{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin-top:20px;max-width:600px;}
.w-badge{background:rgba(255,255,255,.07);border:1px solid var(‚Äìborder);border-radius:50px;padding:6px 16px;font-size:.9rem;}

/* cargo grid */
.cr-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:12px;width:100%;max-width:840px;}
.cr-card{background:rgba(255,255,255,.05);border:1px solid var(‚Äìborder);border-radius:14px;
padding:14px;text-align:center;transition:border-color .3s;}
.cr-card.decided{border-color:var(‚Äìgreen);}
.cr-icon{font-size:clamp(1.8rem,4vw,3rem);}
.cr-pname{font-size:clamp(.62rem,1.1vw,.82rem);color:var(‚Äìmuted);margin-top:6px;}
.cr-cname{font-size:clamp(.75rem,1.4vw,1rem);font-weight:700;margin-top:3px;}
.cr-val{font-size:clamp(.62rem,1.1vw,.78rem);color:var(‚Äìgold);margin-top:4px;}
.cr-icc{font-size:clamp(.58rem,1vw,.72rem);color:var(‚Äìmuted);margin-top:3px;}

/* event grid */
.ev-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px;width:100%;max-width:1000px;}
.ev-card{background:rgba(255,255,255,.05);border:1px solid var(‚Äìborder);border-radius:16px;padding:16px;text-align:center;}
.ev-big-icon{font-size:clamp(1.8rem,4vw,3rem);}
.ev-title{font-family:‚ÄòChakra Petch‚Äô,sans-serif;font-size:clamp(.62rem,1.3vw,.92rem);font-weight:700;margin-top:8px;}
.ev-player{font-size:clamp(.58rem,1vw,.72rem);color:var(‚Äìmuted);}
.ev-icc{font-size:clamp(.55rem,.9vw,.68rem);color:var(‚Äìmuted);}
.ev-change{font-family:‚ÄòChakra Petch‚Äô,sans-serif;font-size:clamp(.9rem,2vw,1.4rem);font-weight:800;margin-top:8px;}
.pos{color:var(‚Äìgreen)}.neg{color:var(‚Äìred)}.gold-c{color:var(‚Äìgold)}

/* leaderboard */
.lb-wrap{text-align:center;width:100%;}
.lb-title{font-family:‚ÄòChakra Petch‚Äô,sans-serif;font-size:clamp(1.5rem,5vw,3.5rem);color:var(‚Äìgold);font-weight:800;margin-bottom:28px;}
.lb-list{display:flex;flex-direction:column;gap:12px;max-width:640px;margin:0 auto;}
.lb-item{display:flex;align-items:center;gap:16px;background:rgba(255,255,255,.05);
border:1px solid var(‚Äìborder);border-radius:16px;padding:16px 22px;animation:slideIn .4s ease both;}
.lb-item.r1{border-color:var(‚Äìgold);background:rgba(245,200,66,.08);}
.lb-item.r2{border-color:#c0c0c0;background:rgba(192,192,192,.05);animation-delay:.15s;}
.lb-item.r3{border-color:#cd7f32;background:rgba(205,127,50,.05);animation-delay:.3s;}
.lb-rank{font-family:‚ÄòChakra Petch‚Äô,sans-serif;font-size:clamp(1.2rem,3vw,2rem);font-weight:800;color:var(‚Äìmuted);min-width:50px;text-align:center;}
.lb-item.r1 .lb-rank{color:var(‚Äìgold);}
.lb-name{flex:1;font-size:clamp(.9rem,2vw,1.4rem);font-weight:600;}
.lb-profit{font-family:‚ÄòChakra Petch‚Äô,sans-serif;font-size:clamp(1rem,2.5vw,1.6rem);font-weight:700;}

/* player cargo */
.mc-banner{background:linear-gradient(135deg,rgba(26,58,110,.8),rgba(10,22,40,.9));
border:1px solid var(‚Äìblue);border-radius:18px;padding:22px;margin-bottom:16px;text-align:center;width:100%;}
.mc-icon{font-size:3rem;}
.mc-name{font-family:‚ÄòChakra Petch‚Äô,sans-serif;font-size:1.3rem;font-weight:800;margin-top:8px;}
.mc-sub{font-size:.82rem;color:var(‚Äìmuted);margin-top:4px;}
.mc-val{display:inline-block;margin-top:10px;background:rgba(245,200,66,.12);border:1px solid rgba(245,200,66,.3);
border-radius:50px;padding:6px 20px;font-family:‚ÄòChakra Petch‚Äô,sans-serif;font-size:1.05rem;color:var(‚Äìgold);}

/* icc options */
.icc-select{width:100%;display:flex;flex-direction:column;gap:8px;margin-bottom:14px;}
.icc-opt{display:flex;align-items:center;gap:12px;background:rgba(255,255,255,.04);
border:2px solid var(‚Äìborder);border-radius:12px;padding:13px 14px;cursor:pointer;transition:all .2s;width:100%;text-align:left;}
.icc-opt:active{transform:scale(.98);}
.icc-opt.sel-none{border-color:var(‚Äìred);background:rgba(230,57,70,.1);}
.icc-opt.sel-iccC{border-color:#aaa;background:rgba(170,170,170,.07);}
.icc-opt.sel-iccB{border-color:var(‚Äìblue);background:rgba(72,149,239,.1);}
.icc-opt.sel-iccA{border-color:var(‚Äìgold);background:rgba(245,200,66,.1);}
.io-icon{font-size:1.4rem;width:28px;text-align:center;flex-shrink:0;}
.io-text{flex:1;}
.io-name{font-family:‚ÄòChakra Petch‚Äô,sans-serif;font-size:.9rem;font-weight:700;}
.io-desc{font-size:.73rem;color:var(‚Äìmuted);margin-top:2px;line-height:1.4;}
.io-cost{font-family:‚ÄòChakra Petch‚Äô,sans-serif;font-size:.82rem;color:var(‚Äìgold);flex-shrink:0;}

/* result */
.rp-event{border-radius:14px;padding:18px;margin-bottom:14px;text-align:center;width:100%;}
.rp-event.safe{background:rgba(45,198,83,.1);border:1px solid var(‚Äìgreen);}
.rp-event.partial_minor,.rp-event.partial_major{background:rgba(255,209,102,.1);border:1px solid var(‚Äìyellow);}
.rp-event.theft{background:rgba(150,50,200,.1);border:1px solid #a050d0;}
.rp-event.total{background:rgba(230,57,70,.1);border:1px solid var(‚Äìred);}
.rp-event.bonus{background:rgba(245,200,66,.1);border:1px solid var(‚Äìgold);}
.rp-ev-icon{font-size:2.5rem;}
.rp-ev-title{font-family:‚ÄòChakra Petch‚Äô,sans-serif;font-size:1rem;font-weight:700;margin-top:8px;}
.rp-ev-desc{font-size:.78rem;color:rgba(255,255,255,.7);margin-top:4px;}
.rp-breakdown{background:rgba(255,255,255,.04);border-radius:12px;padding:14px;margin-bottom:12px;width:100%;}
.rb-row{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid rgba(255,255,255,.06);font-size:.88rem;}
.rb-row:last-child{border-bottom:none;}
.rb-label{color:var(‚Äìmuted);}
.rb-val{font-family:‚ÄòChakra Petch‚Äô,sans-serif;font-weight:600;}
.rp-total{font-family:‚ÄòChakra Petch‚Äô,sans-serif;font-size:1.5rem;font-weight:800;
text-align:center;padding:14px;background:rgba(255,255,255,.05);border-radius:12px;margin-bottom:10px;width:100%;}
.claim-box{background:rgba(45,198,83,.08);border:1px solid rgba(45,198,83,.3);
border-radius:10px;padding:11px 14px;margin-bottom:10px;font-size:.8rem;line-height:1.7;width:100%;}
.no-claim-box{background:rgba(230,57,70,.08);border:1px solid rgba(230,57,70,.3);
border-radius:10px;padding:11px 14px;margin-bottom:10px;font-size:.8rem;line-height:1.7;width:100%;}
.budget-row{display:flex;justify-content:space-between;align-items:center;
background:rgba(255,255,255,.04);border-radius:10px;padding:10px 14px;margin-bottom:14px;width:100%;}
.br-l{font-size:.75rem;color:var(‚Äìmuted);}
.br-v{font-family:‚ÄòChakra Petch‚Äô,sans-serif;font-size:.9rem;color:var(‚Äìgold);}

/* spinner overlay */
#loading{display:none;position:fixed;inset:0;background:rgba(5,13,26,.85);
z-index:100;align-items:center;justify-content:center;flex-direction:column;gap:16px;}
#loading.show{display:flex;}
.spin-ring{width:48px;height:48px;border:4px solid rgba(255,255,255,.1);
border-top-color:var(‚Äìgold);border-radius:50%;animation:spin 1s linear infinite;}
@keyframes spin{to{transform:rotate(360deg)}}
</style>

</head>
<body>

<div id="loading"><div class="spin-ring"></div><div style="color:var(--muted);font-size:.9rem;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...</div></div>

<!-- SPLASH -->

<div id="splash" class="show">
  <div class="splash-ship">üö¢</div>
  <div class="splash-title">CARGO CRISIS</div>
  <div class="splash-sub">‡πÄ‡∏Å‡∏°‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏†‡∏±‡∏¢‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏≤‡∏á‡∏ó‡∏∞‡πÄ‡∏•</div>
  <div class="mode-btns">
    <button class="btn btn-gold" onclick="gotoMode('display')">üì∫ ‡∏à‡∏≠‡πÉ‡∏´‡∏ç‡πà</button>
    <button class="btn btn-ghost" onclick="gotoMode('host')">üéõÔ∏è Host</button>
    <button class="btn btn-ghost" onclick="gotoMode('join')">üë§ ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô</button>
  </div>
</div>

<!-- HOST -->

<div class="screen" id="host">
  <div style="max-width:460px;margin:0 auto;padding:20px 16px 60px;">
    <div class="page-title">üéõÔ∏è HOST PANEL</div>

```
<div id="host-setup">
  <div class="card">
    <div class="card-label">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏Å‡∏°</div>
    <div class="setting-row">
      <div><label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≠‡∏ö</label><input type="number" id="cfg-rounds" value="3" min="1" max="10"></div>
      <div><label>‡∏á‡∏ö‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (‡∏ö‡∏≤‡∏ó)</label><input type="number" id="cfg-budget" value="1000000" step="100000"></div>
    </div>
  </div>
  <div class="card">
    <div class="card-label">‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏≠ (<span id="host-count">0</span>)</div>
    <div id="host-player-list" style="min-height:36px;"></div>
    <p style="font-size:.78rem;color:var(--muted);margin-top:8px;">
      ‡πÉ‡∏´‡πâ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏µ‡πâ‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ ‚Üí ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å <strong style="color:var(--text)">üë§ ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô</strong> ‚Üí ‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠
    </p>
  </div>
  <button class="btn btn-green btn-full" id="start-btn" onclick="hostStart()">üöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°!</button>
  <button class="btn btn-red btn-full" onclick="hostReset()">üóëÔ∏è ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏Å‡∏°</button>
</div>

<div id="host-game" style="display:none;">
  <div class="card">
    <div class="card-label">‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà <span id="hg-round">-</span></div>
    <div id="hg-status" style="font-size:.9rem;color:var(--muted);margin-bottom:12px;">-</div>
    <div id="hg-choices"></div>
  </div>
  <button class="btn btn-gold btn-full" id="hg-spin" onclick="hostSpin()" style="display:none;">üé≤ ‡∏à‡∏±‡πà‡∏ß‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå!</button>
  <button class="btn btn-ghost btn-full" id="hg-next" onclick="hostNext()" style="display:none;">‡∏£‡∏≠‡∏ö‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚Üí</button>
</div>

<div id="host-end" style="display:none;">
  <div class="card">
    <button class="btn btn-gold btn-full" onclick="hostLeaderboard()">üèÜ ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏™‡∏£‡∏∏‡∏õ‡∏ö‡∏ô‡∏à‡∏≠‡πÉ‡∏´‡∏ç‡πà</button>
    <button class="btn btn-ghost btn-full" onclick="hostReset()">üîÑ ‡πÄ‡∏•‡πà‡∏ô‡πÉ‡∏´‡∏°‡πà</button>
  </div>
</div>
```

  </div>
</div>

<!-- JOIN -->

<div class="screen" id="join">
  <div class="join-inner">
    <div class="join-title">‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡πÄ‡∏Å‡∏°</div>
    <div class="join-sub">‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏≠ Host ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°</div>
    <div class="join-form">
      <input type="text" id="join-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì" maxlength="14">
      <button class="btn btn-gold btn-full" onclick="joinGame()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏° ‚Üí</button>
    </div>
    <div style="width:100%;max-width:360px;margin-top:16px;" id="join-waiting"></div>
  </div>
</div>

<!-- PLAYER -->

<div class="screen" id="player">
  <div class="player-inner">
    <div class="page-header">üö¢ CARGO CRISIS</div>
    <div id="player-content" style="width:100%;display:flex;flex-direction:column;align-items:center;"></div>
  </div>
</div>

<!-- DISPLAY -->

<div class="screen" id="display">
  <div class="disp-header">
    <div class="disp-logo">üö¢ CARGO CRISIS</div>
    <div class="scoreboard" id="disp-sb"></div>
  </div>
  <div class="disp-main" id="disp-main"></div>
</div>

<script>
// ‚ïê‚ïê FIREBASE ‚ïê‚ïê
const FB_URL = 'https://cargo-insurance-82335-default-rtdb.asia-southeast1.firebasedatabase.app';
firebase.initializeApp({ databaseURL: FB_URL });
const db = firebase.database();
const gameRef = db.ref('game');

// ‚ïê‚ïê DATA ‚ïê‚ïê
const CARGOS = [
  {icon:'üì±',name:'‡∏™‡∏°‡∏≤‡∏£‡πå‡∏ó‡πÇ‡∏ü‡∏ô',     route:'‡πÑ‡∏ó‡∏¢ ‚Üí ‡∏¢‡∏∏‡πÇ‡∏£‡∏õ',        risk:'‚ö†Ô∏è ‡∏™‡∏π‡∏á',    value:500000},
  {icon:'üåæ',name:'‡∏Ç‡πâ‡∏≤‡∏ß‡∏™‡∏≤‡∏£',       route:'‡πÑ‡∏ó‡∏¢ ‚Üí ‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å‡∏Å‡∏•‡∏≤‡∏á', risk:'‚úÖ ‡∏ï‡πà‡∏≥',    value:200000},
  {icon:'‚öóÔ∏è',name:'‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ',       route:'‡πÑ‡∏ó‡∏¢ ‚Üí ‡∏≠‡πÄ‡∏°‡∏£‡∏¥‡∏Å‡∏≤',      risk:'üî¥ ‡∏™‡∏π‡∏á‡∏°‡∏≤‡∏Å', value:350000},
  {icon:'üíé',name:'‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏î‡∏±‡∏ö', route:'‡πÑ‡∏ó‡∏¢ ‚Üí ‡∏ç‡∏µ‡πà‡∏õ‡∏∏‡πà‡∏ô',      risk:'‚ö†Ô∏è ‡∏™‡∏π‡∏á',    value:800000},
  {icon:'üöó',name:'‡∏ä‡∏¥‡πâ‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏£‡∏ñ‡∏¢‡∏ô‡∏ï‡πå',route:'‡πÑ‡∏ó‡∏¢ ‚Üí ‡∏à‡∏µ‡∏ô',          risk:'üü° ‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á',value:300000},
  {icon:'üñ•Ô∏è',name:'‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏Ñ‡∏≠‡∏°‡∏Ø',  route:'‡πÑ‡∏ó‡∏¢ ‚Üí ‡∏≠‡∏¥‡∏ô‡πÄ‡∏î‡∏µ‡∏¢',      risk:'‚ö†Ô∏è ‡∏™‡∏π‡∏á',    value:420000},
  {icon:'üß¥',name:'‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏™‡∏≥‡∏≠‡∏≤‡∏á', route:'‡πÑ‡∏ó‡∏¢ ‚Üí ‡πÄ‡∏Å‡∏≤‡∏´‡∏•‡∏µ',        risk:'‚úÖ ‡∏ï‡πà‡∏≥',    value:180000},
  {icon:'üêü',name:'‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ó‡∏∞‡πÄ‡∏•',     route:'‡πÑ‡∏ó‡∏¢ ‚Üí ‡∏≠‡∏≠‡∏™‡πÄ‡∏ï‡∏£‡πÄ‡∏•‡∏µ‡∏¢',   risk:'üü° ‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á',value:250000},
  {icon:'üõ¢Ô∏è',name:'‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡∏õ‡∏≤‡∏•‡πå‡∏°',  route:'‡πÑ‡∏ó‡∏¢ ‚Üí ‡∏≠‡∏¥‡∏ô‡πÄ‡∏î‡∏µ‡∏¢',      risk:'‚úÖ ‡∏ï‡πà‡∏≥',    value:150000},
  {icon:'üèóÔ∏è',name:'‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£',  route:'‡πÑ‡∏ó‡∏¢ ‚Üí ‡πÅ‡∏≠‡∏ü‡∏£‡∏¥‡∏Å‡∏≤',      risk:'üü° ‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á',value:600000},
  {icon:'üç´',name:'‡∏ä‡πá‡∏≠‡∏Å‡πÇ‡∏Å‡πÅ‡∏•‡∏ï',    route:'‡πÑ‡∏ó‡∏¢ ‚Üí ‡∏™‡∏´‡∏£‡∏±‡∏ê‡∏Ø',       risk:'‚úÖ ‡∏ï‡πà‡∏≥',    value:120000},
  {icon:'üîã',name:'‡πÅ‡∏ö‡∏ï‡πÄ‡∏ï‡∏≠‡∏£‡∏µ‡πà EV',  route:'‡πÑ‡∏ó‡∏¢ ‚Üí ‡∏¢‡∏∏‡πÇ‡∏£‡∏õ',        risk:'üî¥ ‡∏™‡∏π‡∏á‡∏°‡∏≤‡∏Å', value:750000},
];
const ICC = {
  none: {id:'none',icon:'‚ùå',name:'‡πÑ‡∏°‡πà‡∏ã‡∏∑‡πâ‡∏≠‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô',   rate:0,   desc:'‡∏£‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏≠‡∏á ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏°'},
  iccC: {id:'iccC',icon:'üîµ',name:'ICC C',           rate:.01, desc:'‡∏Ñ‡∏∏‡πâ‡∏°‡∏Ñ‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Total Loss (‡∏à‡∏°‡πÄ‡∏£‡∏∑‡∏≠/‡πÇ‡∏à‡∏£‡∏™‡∏•‡∏±‡∏î/‡∏£‡∏∞‡πÄ‡∏ö‡∏¥‡∏î)'},
  iccB: {id:'iccB',icon:'üü£',name:'ICC B',           rate:.02, desc:'Total Loss + ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏Å (‡∏û‡∏≤‡∏¢‡∏∏/‡πÄ‡∏Ñ‡∏£‡∏ô‡∏ï‡∏Å/‡πÑ‡∏ü‡πÑ‡∏´‡∏°‡πâ)'},
  iccA: {id:'iccA',icon:'üü°',name:'ICC A (All Risks)',rate:.03, desc:'All Risks ‡∏£‡∏ß‡∏°‡∏ñ‡∏∂‡∏á‡∏Ç‡πÇ‡∏°‡∏¢/‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô/‡πÅ‡∏°‡∏•‡∏á'},
};
const EVENTS = [
  {type:'safe',         icon:'‚öì', title:'‡∏™‡πà‡∏á‡∏ñ‡∏∂‡∏á‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢', desc:'‡πÄ‡∏£‡∏∑‡∏≠‡πÅ‡∏•‡πà‡∏ô‡∏ï‡∏≤‡∏°‡∏Å‡∏≥‡∏´‡∏ô‡∏î ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÉ‡∏î',              lossRate:0,   covers:[], w:8},
  {type:'safe',         icon:'üå§Ô∏è',title:'‡∏™‡∏†‡∏≤‡∏û‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡∏î‡∏µ‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°',    desc:'‡∏ó‡∏∞‡πÄ‡∏•‡∏™‡∏á‡∏ö ‡πÄ‡∏£‡∏∑‡∏≠‡∏ñ‡∏∂‡∏á‡πÄ‡∏£‡πá‡∏ß‡∏Å‡∏ß‡πà‡∏≤‡∏Å‡∏≥‡∏´‡∏ô‡∏î',                  lossRate:0,   covers:[], w:7},
  {type:'partial_minor',icon:'üíß',title:'‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡∏ó‡∏≥‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢',desc:'‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡πÉ‡∏ô‡∏ï‡∏π‡πâ‡∏™‡∏π‡∏á ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢ 20%',            lossRate:.20, covers:['iccA'], w:4},
  {type:'partial_minor',icon:'üêõ',title:'‡πÅ‡∏°‡∏•‡∏á‡∏£‡∏ö‡∏Å‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤',       desc:'‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢ 15%',                         lossRate:.15, covers:['iccA'], w:3},
  {type:'partial_major',icon:'üåä',title:'‡∏Ñ‡∏•‡∏∑‡πà‡∏ô‡∏û‡∏≤‡∏¢‡∏∏‡πÄ‡∏Ç‡πâ‡∏≤‡∏õ‡∏∞‡∏ó‡∏∞',     desc:'‡∏ô‡πâ‡∏≥‡∏ó‡∏∞‡πÄ‡∏•‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏≤‡∏á ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢ 35%',            lossRate:.35, covers:['iccB','iccA'], w:5},
  {type:'partial_major',icon:'üèóÔ∏è',title:'‡∏ï‡∏π‡πâ‡∏ï‡∏Å‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏Ç‡∏ô‡∏ñ‡πà‡∏≤‡∏¢',   desc:'‡πÄ‡∏Ñ‡∏£‡∏ô‡∏Ç‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏á ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢ 30%',                 lossRate:.30, covers:['iccB','iccA'], w:5},
  {type:'partial_major',icon:'üî•',title:'‡πÑ‡∏ü‡πÑ‡∏´‡∏°‡πâ‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô',          desc:'‡πÄ‡∏û‡∏•‡∏¥‡∏á‡πÑ‡∏´‡∏°‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ß‡∏≤‡∏á ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢ 50%',            lossRate:.50, covers:['iccB','iccA'], w:4},
  {type:'partial_major',icon:'ü•µ',title:'‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏¢‡πá‡∏ô‡∏Ç‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏á', desc:'Refrigeration ‡πÄ‡∏™‡∏µ‡∏¢ ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢ 40%',           lossRate:.40, covers:['iccB','iccA'], w:3},
  {type:'theft',        icon:'ü•∑',title:'‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ñ‡∏π‡∏Å‡∏Ç‡πÇ‡∏°‡∏¢',          desc:'‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏´‡∏≤‡∏¢‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏Ç‡∏ô‡∏ñ‡πà‡∏≤‡∏¢ 40%',                     lossRate:.40, covers:['iccA'], w:3},
  {type:'total',        icon:'üåÄ',title:'‡∏û‡∏≤‡∏¢‡∏∏‡πÑ‡∏ï‡πâ‡∏ù‡∏∏‡πà‡∏ô!',            desc:'‡πÄ‡∏£‡∏∑‡∏≠‡∏•‡πà‡∏°‡∏Å‡∏•‡∏≤‡∏á‡∏ó‡∏∞‡πÄ‡∏• ‡∏™‡∏π‡∏ç‡πÄ‡∏™‡∏µ‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î',                 lossRate:1,   covers:['iccC','iccB','iccA'], w:3},
  {type:'total',        icon:'üè¥‚Äç‚ò†Ô∏è',title:'‡πÇ‡∏à‡∏£‡∏™‡∏•‡∏±‡∏î‡πÇ‡∏à‡∏°‡∏ï‡∏µ!',         desc:'‡πÄ‡∏£‡∏∑‡∏≠‡∏ñ‡∏π‡∏Å‡∏¢‡∏∂‡∏î ‡∏™‡∏π‡∏ç‡πÄ‡∏™‡∏µ‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î',                      lossRate:1,   covers:['iccC','iccB','iccA'], w:2},
  {type:'total',        icon:'üí•',title:'‡∏£‡∏∞‡πÄ‡∏ö‡∏¥‡∏î‡πÉ‡∏ô‡∏£‡∏∞‡∏ß‡∏≤‡∏á!',           desc:'‡πÄ‡∏´‡∏ï‡∏∏‡πÑ‡∏°‡πà‡∏Ñ‡∏≤‡∏î‡∏ù‡∏±‡∏ô ‡∏™‡∏π‡∏ç‡πÄ‡∏™‡∏µ‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î',                  lossRate:1,   covers:['iccC','iccB','iccA'], w:2},
  {type:'bonus',        icon:'‚≠ê',title:'‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≤‡∏î‡∏ï‡∏•‡∏≤‡∏î!',          desc:'‡∏£‡∏≤‡∏Ñ‡∏≤‡∏û‡∏∏‡πà‡∏á‡∏™‡∏π‡∏á ‡πÑ‡∏î‡πâ‡∏Å‡∏≥‡πÑ‡∏£‡∏û‡∏¥‡πÄ‡∏®‡∏© +20%',                 lossRate:-.20,covers:[], w:2},
  {type:'bonus',        icon:'üèÜ',title:'‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°!',   desc:'‡∏™‡πà‡∏á‡πÄ‡∏£‡πá‡∏ß‡∏Å‡∏ß‡πà‡∏≤‡∏Å‡∏≥‡∏´‡∏ô‡∏î ‡πÑ‡∏î‡πâ‡∏Ñ‡πà‡∏≤‡∏ï‡∏≠‡∏ö‡πÅ‡∏ó‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏© +15%',       lossRate:-.15,covers:[], w:2},
];

// ‚ïê‚ïê HELPERS ‚ïê‚ïê
function fmt(n){return '‡∏ø'+Math.abs(Math.round(n)).toLocaleString('th-TH');}
function fmtS(n){return (n>=0?'+':'-')+'‡∏ø'+Math.abs(Math.round(n)).toLocaleString('th-TH');}
function weighted(arr){const t=arr.reduce((s,i)=>s+i.w,0);let r=Math.random()*t;for(const x of arr){r-=x.w;if(r<=0)return x;}return arr[arr.length-1];}
function loading(on){document.getElementById('loading').className=on?'show':'';}

let myName=null;
let currentMode=null;
let G=null; // live state from Firebase

// ‚ïê‚ïê NAVIGATION ‚ïê‚ïê
function gotoMode(m){
  currentMode=m;
  document.getElementById('splash').classList.remove('show');
  ['host','join','player','display'].forEach(id=>document.getElementById(id).classList.remove('show'));
  document.getElementById(m).classList.add('show');

  if(m==='host')   initHost();
  if(m==='join')   initJoin();
  if(m==='player') initPlayer();
  if(m==='display')initDisplay();
}

// ‚ïê‚ïê FIREBASE LISTENER ‚ïê‚ïê
function listenGame(cb){
  gameRef.on('value', snap=>{ G=snap.val()||{}; cb(G); });
}

// ‚ïê‚ïê HOST ‚ïê‚ïê
function initHost(){
  listenGame(g=>{
    if(!g.phase||g.phase==='lobby'){
      showSetup(g);
    } else if(g.phase==='round'||g.phase==='event'){
      document.getElementById('host-setup').style.display='none';
      document.getElementById('host-game').style.display='block';
      document.getElementById('host-end').style.display='none';
      renderHostGame(g);
    } else if(g.phase==='end'){
      document.getElementById('host-setup').style.display='none';
      document.getElementById('host-game').style.display='none';
      document.getElementById('host-end').style.display='block';
    }
  });
}

function showSetup(g){
  document.getElementById('host-setup').style.display='block';
  document.getElementById('host-game').style.display='none';
  document.getElementById('host-end').style.display='none';
  const players=g.players?Object.values(g.players):[];
  document.getElementById('host-count').textContent=players.length;
  const list=document.getElementById('host-player-list');
  list.innerHTML=players.length
    ?players.map(p=>`<div class="player-chip"><span>üë§ <strong>${p.name}</strong></span></div>`).join('')
    :'<div style="font-size:.82rem;color:var(--muted);">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô</div>';
}

function hostStart(){
  const g=G||{};
  const players=g.players?Object.values(g.players):[];
  if(!players.length){alert('‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏Ñ‡∏ô');return;}
  const rounds=parseInt(document.getElementById('cfg-rounds').value)||3;
  const budget=parseInt(document.getElementById('cfg-budget').value)||1000000;
  players.forEach(p=>{p.budget=budget;p.profit=0;});
  const playersObj={};
  players.forEach(p=>{playersObj[p.name]=p;});
  loading(true);
  const assignments=buildAssignments(players);
  gameRef.set({
    phase:'round',rounds,round:0,
    players:playersObj,
    assignments,
    displayState:{type:'cargo',round:0},
  }).then(()=>loading(false));
}

function buildAssignments(players){
  const shuffled=[...CARGOS].sort(()=>Math.random()-.5);
  const obj={};
  players.forEach((p,i)=>{
    obj[p.name]={playerName:p.name,cargo:shuffled[i%shuffled.length],icc:null,decided:false,eventResult:null};
  });
  return obj;
}

function renderHostGame(g){
  document.getElementById('hg-round').textContent=`${g.round+1}/${g.rounds}`;
  const assigns=g.assignments?Object.values(g.assignments):[];
  const allDone=assigns.length&&assigns.every(a=>a.decided);
  const st=document.getElementById('hg-status');
  const spin=document.getElementById('hg-spin');
  const next=document.getElementById('hg-next');
  if(g.phase==='event'){
    st.textContent='‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡πÅ‡∏•‡πâ‡∏ß!';spin.style.display='none';next.style.display='block';
  } else if(allDone){
    st.textContent='‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏à‡∏±‡πà‡∏ß! ‚úÖ';spin.style.display='block';next.style.display='none';
  } else {
    const done=assigns.filter(a=>a.decided).length;
    st.textContent=`‡∏£‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô... (${done}/${assigns.length})`;
    spin.style.display='none';next.style.display='none';
  }
  document.getElementById('hg-choices').innerHTML=assigns.map(a=>`
    <div class="choice-row">
      <span>${a.playerName} <span style="font-size:.7rem;color:var(--muted);">${a.cargo.icon}${a.cargo.name}</span></span>
      <span style="color:${a.decided?'var(--green)':'var(--muted)'};">${a.decided?ICC[a.icc].name:'‡∏£‡∏≠...'}</span>
    </div>`).join('');
}

function hostSpin(){
  const g=G;
  const assigns=g.assignments?Object.values(g.assignments):[];
  const players=g.players||{};
  assigns.forEach(a=>{
    const ev=weighted(EVENTS);
    const icc=ICC[a.icc];
    const cv=a.cargo.value;
    const premium=Math.round(cv*icc.rate);
    const rawLoss=ev.lossRate>0?Math.round(cv*ev.lossRate):0;
    const gain=ev.lossRate<0?Math.round(cv*Math.abs(ev.lossRate)):0;
    const canClaim=ev.covers.includes(a.icc);
    const claimAmt=canClaim?rawLoss:0;
    const netChange=gain-rawLoss+claimAmt-premium;
    a.eventResult={ev,rawLoss,gain,premium,claimAmt,netChange,canClaim,cargoVal:cv};
    if(players[a.playerName]) players[a.playerName].profit=(players[a.playerName].profit||0)+netChange;
  });
  const assignsObj={};
  assigns.forEach(a=>{assignsObj[a.playerName]=a;});
  loading(true);
  gameRef.update({
    phase:'event',
    assignments:assignsObj,
    players,
    displayState:{type:'event',round:g.round},
  }).then(()=>loading(false));
}

function hostNext(){
  const g=G;
  const nextRound=g.round+1;
  if(nextRound>=g.rounds){
    loading(true);
    gameRef.update({phase:'end',displayState:null}).then(()=>loading(false));
    return;
  }
  const players=g.players?Object.values(g.players):[];
  const assignments=buildAssignments(players);
  loading(true);
  gameRef.update({phase:'round',round:nextRound,assignments,displayState:{type:'cargo',round:nextRound}}).then(()=>loading(false));
}

function hostLeaderboard(){
  loading(true);
  gameRef.update({displayState:{type:'leaderboard'}}).then(()=>loading(false));
}

function hostReset(){
  if(!confirm('‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏Å‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?'))return;
  loading(true);
  gameRef.set({phase:'lobby',players:{},assignments:{},rounds:3,round:0,displayState:null}).then(()=>loading(false));
}

// ‚ïê‚ïê JOIN ‚ïê‚ïê
function initJoin(){
  listenGame(g=>{
    if(g.phase&&g.phase!=='lobby'&&myName){
      gotoMode('player');return;
    }
    const players=g.players?Object.values(g.players):[];
    document.getElementById('join-waiting').innerHTML=players.map(p=>`<div class="w-chip">üë§ ${p.name}</div>`).join('');
  });
}

function joinGame(){
  const n=document.getElementById('join-name').value.trim();
  if(!n){alert('‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏∞!');return;}
  const g=G||{};
  if(g.phase&&g.phase!=='lobby'){alert('‡πÄ‡∏Å‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏•‡πâ‡∏ß ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡πÑ‡∏î‡πâ');return;}
  const players=g.players||{};
  if(players[n]){alert('‡∏ä‡∏∑‡πà‡∏≠‡∏ã‡πâ‡∏≥ ‡∏•‡∏≠‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏∑‡πà‡∏ô‡∏ô‡∏∞');return;}
  loading(true);
  db.ref(`game/players/${n}`).set({name:n,budget:1000000,profit:0}).then(()=>{
    loading(false);
    myName=n;
    localStorage.setItem('cg_name',n);
    gotoMode('player');
  });
}

// ‚ïê‚ïê PLAYER ‚ïê‚ïê
function initPlayer(){
  if(!myName){myName=localStorage.getItem('cg_name');}
  listenGame(g=>renderPlayer(g));
}

function renderPlayer(g){
  const el=document.getElementById('player-content');
  if(!el||!myName)return;
  const p=g.players&&g.players[myName];
  if(!p){
    el.innerHTML=`<div style="text-align:center;padding-top:50px;">
      <div style="font-size:3rem;animation:float 3s ease-in-out infinite;">‚öì</div>
      <div style="font-family:'Chakra Petch',sans-serif;color:var(--muted);margin-top:14px;">‡∏£‡∏≠ Host ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°...</div>
    </div>`;return;
  }

  if(!g.phase||g.phase==='lobby'){
    const cnt=g.players?Object.keys(g.players).length:0;
    el.innerHTML=`<div style="text-align:center;padding-top:50px;">
      <div style="font-size:3rem;animation:float 3s ease-in-out infinite;">‚öì</div>
      <div style="font-family:'Chakra Petch',sans-serif;color:var(--gold);margin-top:14px;">‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ ${myName}!</div>
      <div style="color:var(--muted);font-size:.9rem;margin-top:8px;">‡∏£‡∏≠ Host ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°... (${cnt} ‡∏Ñ‡∏ô)</div>
    </div>`;return;
  }

  if(g.phase==='end'){
    const sorted=Object.values(g.players).sort((a,b)=>b.profit-a.profit);
    const rank=sorted.findIndex(x=>x.name===myName)+1;
    el.innerHTML=`<div style="text-align:center;padding-top:30px;width:100%;">
      <div style="font-size:4rem;">${['ü•á','ü•à','ü•â'][rank-1]||rank}</div>
      <div style="font-family:'Chakra Petch',sans-serif;font-size:1.4rem;margin-top:10px;">‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö ${rank}</div>
      <div style="color:var(--muted);font-size:.85rem;margin-top:4px;">‡∏Å‡∏≥‡πÑ‡∏£‡∏™‡∏∏‡∏ó‡∏ò‡∏¥‡∏ó‡∏±‡πâ‡∏á‡πÄ‡∏Å‡∏°</div>
      <div style="font-family:'Chakra Petch',sans-serif;font-size:2rem;font-weight:800;margin-top:6px;
        color:${p.profit>=0?'var(--green)':'var(--red)'};">${fmtS(p.profit)}</div>
    </div>`;return;
  }

  const a=g.assignments&&g.assignments[myName];
  if(!a){
    el.innerHTML=`<div style="text-align:center;padding-top:50px;color:var(--muted);">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>`;return;
  }

  if(g.phase==='event'&&a.eventResult){renderPlayerEvent(el,a,p);return;}

  if(a.decided){
    el.innerHTML=`<div style="text-align:center;padding-top:40px;width:100%;">
      <div style="font-size:2.5rem;">‚è≥</div>
      <div style="font-family:'Chakra Petch',sans-serif;color:var(--muted);font-size:.95rem;margin-top:12px;">
        ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å <span style="color:var(--gold);">${ICC[a.icc].name}</span> ‡πÅ‡∏•‡πâ‡∏ß<br>
        <span style="font-size:.8rem;opacity:.6;">‡∏£‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏Ñ‡∏ô‡∏≠‡∏∑‡πà‡∏ô...</span>
      </div>
    </div>`;return;
  }

  // Choose ICC
  const cv=a.cargo.value;
  el.innerHTML=`
    <div class="budget-row">
      <div><div class="br-l">‡∏á‡∏ö‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</div><div class="br-v">${fmt(p.budget+(p.profit||0))}</div></div>
      <div><div class="br-l">‡∏£‡∏≠‡∏ö</div><div class="br-v">${(g.round||0)+1}/${g.rounds}</div></div>
    </div>
    <div class="mc-banner">
      <div class="mc-icon">${a.cargo.icon}</div>
      <div class="mc-name">${a.cargo.name}</div>
      <div class="mc-sub">${a.cargo.route} | ${a.cargo.risk}</div>
      <div class="mc-val">‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ${fmt(cv)}</div>
    </div>
    <div class="card" style="width:100%;">
      <div class="card-label">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∏‡πâ‡∏°‡∏Ñ‡∏£‡∏≠‡∏á</div>
      <div class="icc-select">${buildIccOpts(cv)}</div>
      <button class="btn btn-gold btn-full" id="confirm-btn" onclick="playerConfirm('${myName}')" disabled>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô ‚úì</button>
    </div>`;
  window._selIcc=null;
}

function buildIccOpts(cv){
  return Object.values(ICC).map(ic=>`
    <button class="icc-opt" id="io-${ic.id}" onclick="selIcc('${ic.id}')">
      <div class="io-icon">${ic.icon}</div>
      <div class="io-text">
        <div class="io-name">${ic.name}</div>
        <div class="io-desc">${ic.desc}</div>
      </div>
      <div class="io-cost">${ic.rate>0?fmt(Math.round(cv*ic.rate)):'‡∏ü‡∏£‡∏µ'}</div>
    </button>`).join('');
}

function selIcc(id){
  window._selIcc=id;
  Object.keys(ICC).forEach(k=>{
    const el=document.getElementById('io-'+k);
    if(el)el.className='icc-opt'+(k===id?' sel-'+id:'');
  });
  const btn=document.getElementById('confirm-btn');
  if(btn){btn.disabled=false;}
}

function playerConfirm(name){
  if(!window._selIcc)return;
  loading(true);
  db.ref(`game/assignments/${name}`).update({icc:window._selIcc,decided:true}).then(()=>loading(false));
}

function renderPlayerEvent(el,a,p){
  const r=a.eventResult;
  const ev=r.ev;
  const icc=ICC[a.icc];
  let claimHtml='';
  if(a.icc==='none'){
    claimHtml=`<div class="no-claim-box">‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô ‡∏£‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏≠‡∏á</div>`;
  }else if(r.canClaim){
    claimHtml=`<div class="claim-box">‚úÖ <strong>${icc.name}</strong> ‡∏Ñ‡∏∏‡πâ‡∏°‡∏Ñ‡∏£‡∏≠‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏ô‡∏µ‡πâ ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏Ñ‡∏•‡∏° <strong>${fmt(r.claimAmt)}</strong></div>`;
  }else{
    const why={
      partial_minor:'‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ ICC A ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏∏‡πâ‡∏°‡∏Ñ‡∏£‡∏≠‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢',
      theft:'‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ ICC A ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏∏‡πâ‡∏°‡∏Ñ‡∏£‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ç‡πÇ‡∏°‡∏¢',
      partial_major:'‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ ICC B ‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏∏‡πâ‡∏°‡∏Ñ‡∏£‡∏≠‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô',
    }[ev.type]||'‡∏Å‡∏£‡∏°‡∏ò‡∏£‡∏£‡∏°‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏•‡∏∏‡∏°‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏ô‡∏µ‡πâ';
    claimHtml=`<div class="no-claim-box">‚ö†Ô∏è <strong>${icc.name}</strong> ‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏•‡∏∏‡∏°‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏ô‡∏µ‡πâ<br><small>${why}</small></div>`;
  }
  el.innerHTML=`
    <div class="rp-event ${ev.type}">
      <div class="rp-ev-icon">${ev.icon}</div>
      <div class="rp-ev-title">${ev.title}</div>
      <div class="rp-ev-desc">${ev.desc}</div>
    </div>
    ${claimHtml}
    <div class="rp-breakdown">
      <div class="rb-row"><span class="rb-label">‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</span><span class="rb-val gold-c">${fmt(r.cargoVal)}</span></div>
      ${r.gain>0?`<div class="rb-row"><span class="rb-label">‡πÇ‡∏ö‡∏ô‡∏±‡∏™</span><span class="rb-val pos">+${fmt(r.gain)}</span></div>`:''}
      ${r.rawLoss>0?`<div class="rb-row"><span class="rb-label">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢</span><span class="rb-val neg">-${fmt(r.rawLoss)}</span></div>`:''}
      ${r.claimAmt>0?`<div class="rb-row"><span class="rb-label">‡πÄ‡∏Ñ‡∏•‡∏°‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô</span><span class="rb-val pos">+${fmt(r.claimAmt)}</span></div>`:''}
      ${r.premium>0?`<div class="rb-row"><span class="rb-label">‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô (${(icc.rate*100).toFixed(0)}%)</span><span class="rb-val neg">-${fmt(r.premium)}</span></div>`:''}
    </div>
    <div class="rp-total" style="color:${r.netChange>=0?'var(--green)':'var(--red)'};">‡∏Å‡∏≥‡πÑ‡∏£‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ: ${fmtS(r.netChange)}</div>
    <div style="text-align:center;font-size:.85rem;color:var(--muted);width:100%;margin-top:4px;">
      ‡∏Å‡∏≥‡πÑ‡∏£‡∏™‡∏∞‡∏™‡∏°: <span style="font-family:'Chakra Petch',sans-serif;color:var(--gold);">${fmtS(p.profit||0)}</span>
    </div>`;
}

// ‚ïê‚ïê DISPLAY ‚ïê‚ïê
function initDisplay(){
  listenGame(g=>renderDisplay(g));
}

function renderDisplay(g){
  // Scoreboard
  const sb=document.getElementById('disp-sb');
  if(sb&&g.players){
    sb.innerHTML=Object.values(g.players).map(p=>`
      <div class="sc">
        <div class="sc-name">${p.name}</div>
        <div class="sc-val">${(p.profit||0)>=0?'+':'-'}‡∏ø${(Math.abs(p.profit||0)/1000).toFixed(0)}K</div>
      </div>`).join('');
  }

  const main=document.getElementById('disp-main');
  if(!main)return;
  const s=g.displayState;

  // LOBBY
  if(!s||!g.phase||g.phase==='lobby'){
    const players=g.players?Object.values(g.players):[];
    main.innerHTML=`<div class="idle-wrap">
      <div class="idle-ship">üö¢</div>
      <div class="idle-t">‡∏£‡∏≠ Host ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°...</div>
      <div class="idle-sub">‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô: ‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏µ‡πâ ‚Üí ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å üë§ ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô ‚Üí ‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠</div>
      <div class="w-badges">${players.map(p=>`<div class="w-badge">üë§ ${p.name}</div>`).join('')}</div>
    </div>`;return;
  }

  // CARGO PHASE
  if(s.type==='cargo'){
    const assigns=g.assignments?Object.values(g.assignments):[];
    main.innerHTML=`<div style="text-align:center;width:100%;">
      <div style="font-family:'Chakra Petch',sans-serif;font-size:clamp(.9rem,2.5vw,1.6rem);
        color:var(--muted);margin-bottom:20px;letter-spacing:2px;">üóìÔ∏è ‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà ${(g.round||0)+1} / ${g.rounds} ‚Äî ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô</div>
      <div class="cr-grid">
        ${assigns.map(a=>`
          <div class="cr-card ${a.decided?'decided':''}">
            <div class="cr-icon">${a.cargo.icon}</div>
            <div class="cr-pname">üë§ ${a.playerName}</div>
            <div class="cr-cname">${a.cargo.name}</div>
            <div class="cr-val">${fmt(a.cargo.value)}</div>
            <div class="cr-icc">${a.decided?'‚úÖ '+ICC[a.icc].name:'‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å...'}</div>
          </div>`).join('')}
      </div>
    </div>`;return;
  }

  // EVENT PHASE
  if(s.type==='event'){
    const assigns=g.assignments?Object.values(g.assignments):[];
    main.innerHTML=`<div style="width:100%;max-width:1000px;">
      <div style="font-family:'Chakra Petch',sans-serif;font-size:clamp(.9rem,2.5vw,1.8rem);
        color:var(--muted);text-align:center;margin-bottom:18px;">üí• ‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà ${(g.round||0)+1}</div>
      <div class="ev-grid">
        ${assigns.map(a=>{
          const r=a.eventResult;if(!r)return '';
          const ev=r.ev;
          return `<div class="ev-card">
            <div class="ev-big-icon">${ev.icon}</div>
            <div class="ev-title">${ev.title}</div>
            <div class="ev-player">${a.playerName}</div>
            <div class="ev-icc">${ICC[a.icc].name} ${r.canClaim?'‚úÖ':'‚ùå'}</div>
            <div class="ev-change ${r.netChange>=0?'pos':'neg'}">${fmtS(r.netChange)}</div>
          </div>`;
        }).join('')}
      </div>
    </div>`;return;
  }

  // LEADERBOARD
  if(s.type==='leaderboard'){
    const sorted=g.players?Object.values(g.players).sort((a,b)=>b.profit-a.profit):[];
    main.innerHTML=`<div class="lb-wrap">
      <div class="lb-title">üèÜ ‡∏ú‡∏•‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢</div>
      <div class="lb-list">
        ${sorted.map((p,i)=>`
          <div class="lb-item ${i===0?'r1':i===1?'r2':i===2?'r3':''}">
            <div class="lb-rank">${['ü•á','ü•à','ü•â'][i]||i+1}</div>
            <div class="lb-name">${p.name}</div>
            <div class="lb-profit ${(p.profit||0)>=0?'pos':'neg'}">${fmtS(p.profit||0)}</div>
          </div>`).join('')}
      </div>
    </div>`;return;
  }
}

// ‚ïê‚ïê INIT ‚ïê‚ïê
window.onload=()=>{
  myName=localStorage.getItem('cg_name')||null;
};
</script>

</body>
</html>
